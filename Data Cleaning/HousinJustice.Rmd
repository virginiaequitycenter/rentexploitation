---
title: "Housing Justice"
output:
  html_document: 
    code_folding: "hide" 
  date: '2022-06-21'
---

```{r}
#code_folding: "hide" (hides the code but ppl can see the code if they want to)
knitr::opts_chunk$set(echo =  TRUE, warning = FALSE, message = FALSE) #doesn't show the messages or the warings, only code output, must be its in own code chunk to apply to all the subsequent ones
```

``` {r}

#importing data
library(readr)
library(tidycensus)
library(tidyverse)
library(tigris)
library(leaflet)
library(sf)

ACS_Housing_Data <- read_csv("Housing_Data.csv")
Income_By_Tenure <- read_csv("Income_By_Tenure.csv")
Tenure <- read_csv("Tenure.csv")
Tenure_By_Income <- read_csv("Tenure_By_Income.csv")
Tenure_By_Race <- read_csv("Tenurebyrace.csv")
Poverty_By_Race <- read_csv("_PovertyByRace.csv")


```

Some More Data Cleaning...

```{r}

#replacing all household income with the rent occupied household income since that's our focus

ACS_Housing_Data$MedianIncomeE <- Income_By_Tenure$B25119_003E
ACS_Housing_Data$MedianIncomeM <- Income_By_Tenure$B25119_003M

v20 <- load_variables(2020, "acs5", cache = TRUE)
Tenure_By_Income <- v20 %>% 
  filter(str_detect(name, "B25118")) %>% 
  full_join(Tenure_By_Income, v20, by = c("name" = "variable")) %>% 
  select(1,2,5,6,7,8) 

Tenure_By_Income <- Tenure_By_Income %>% 
  mutate(County = case_when(
    str_detect(GEOID, "51540") ~ "Charlottesville", 
    str_detect(GEOID, "51109") ~ "Louisa",
    str_detect(GEOID, "51125") ~ "Nelson",
    str_detect(GEOID, "51065") ~ "Fluvanna",
    str_detect(GEOID, "51003") ~ "Albemarle",
    str_detect(GEOID, "51079") ~ "Greene",
    str_detect(GEOID, "51760") ~ "Richmond City", 
    str_detect(GEOID, "51087") ~ "Henrico",
    str_detect(GEOID, "51041") ~ "Chesterfield",
    str_detect(GEOID, "51670") ~ "Hopewell",
    str_detect(GEOID, "51730") ~ "Petersburg City"
  )) |>
  select(3, 4, 7, 1, 2, 5, 6)

#Tenure_By_Income %>% 
 # group_by(label) %>% 
  #summarize(n = n())

cvlcharlottlesville <- c("003", "540", "079","109", "065", "125")
cvlrichmond <- c("760", "087", "041", "670", "730")


#unique(Tenure_By_Income$label), used this line for the code below, wanted to change the variable name the census gave me

Tenure_By_Income <- Tenure_By_Income %>% 
   mutate(County_fips = str_sub(GEOID, 3,5),
          label = case_when( 
     label %in% "Estimate!!Total:!!Renter occupied:!!$150,000 or more" ~ "Renter occupied: $>150k", 
     label %in% "Estimate!!Total:!!Renter occupied:!!$100,000 to $149,999" ~ "Renter occupied: $100k to  $149,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$75,000 to $99,999" ~ "Renter occupied: $75k to $99,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$50,000 to $74,999" ~ "Renter occupied: $50k to $74,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$35,000 to $49,999" ~ "Renter occupied: $35k to $49,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$25,000 to $34,999" ~ "Renter occupied: $25k to $34,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$20,000 to $24,999" ~ "Renter occupied: $20k to $24,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$15,000 to $19,999" ~ "Renter occupied: $15k to $19,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$10,000 to $14,999" ~ "Renter occupied: $10k to $14,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!$5,000 to $9,999" ~ "Renter occupied: $5k to $9,999",
     label %in% "Estimate!!Total:!!Renter occupied:!!Less than $5,000" ~ "Renter occupied: <$5k",    
     label %in% "Estimate!!Total:!!Renter occupied:" ~ "Renter Occupied",
     label %in% "Estimate!!Total:!!Owner occupied:!!$150,000 or more" ~ "Owner occupied: $>150k",
     label %in% "Estimate!!Total:!!Owner occupied:!!$100,000 to $149,999" ~ "Owner occupied: $100k to  $149,999", 
     label %in% "Estimate!!Total:!!Owner occupied:!!$75,000 to $99,999" ~ "Owner occupied: $75k to $99,999",
     label %in% "Estimate!!Total:!!Owner occupied:!!$50,000 to $74,999" ~ "Owner occupied: $50k to $74,999",
     label %in% "Estimate!!Total:!!Owner occupied:!!$35,000 to $49,999" ~ "Owner occupied: $35k to $49,999",      
     label %in% "Estimate!!Total:!!Owner occupied:!!$25,000 to $34,999" ~ "Owner occupied: $25k to $34,999",
     label %in% "Estimate!!Total:!!Owner occupied:!!$20,000 to $24,999" ~ "Owner occupied: $20k to $24,999",
     label %in% "Estimate!!Total:!!Owner occupied:!!$15,000 to $19,999" ~ "Owner occupied: $15k to $19,999",
     label %in% "Estimate!!Total:!!Owner occupied:!!$10,000 to $14,999" ~ "Owner occupied: $10k to $14,999",
     label %in% "Estimate!!Total:!!Owner occupied:!!$5,000 to $9,999" ~ "Owner occupied: $5k to $9,999",
     label %in% "Estimate!!Total:!!Owner occupied:!!Less than $5,000" ~ "Owner occupied: <$5k",
     label %in% "Estimate!!Total:!!Owner occupied:" ~ "Owner Occupied",
     label %in% "Estimate!!Total:" ~ "Total"),
     Region = case_when(
    County_fips %in% cvlcharlottlesville ~ "Charlottlesville",
    County_fips %in% cvlrichmond ~ "Richmond")
    )  %>% 
  rename(Variable_Code = name, Variable = label) %>% 
  select(1, 8, 2, 3, 9, 4, 5, 6, 7)


# # The Richmond, VA MSA contains the following areas: Amelia County, VA; Charles City County, VA; Chesterfield County, VA; 
# Dinwiddie County, VA; Goochland County, VA; Hanover County, VA; Henrico County, VA; King William County, VA; New Kent County, VA;
# Powhatan County, VA; Prince George County, VA; Sussex County, VA; Colonial Heights city, VA; Hopewell city, VA; 
# Petersburg city, VA; and Richmond city, VA. 

# The Charlottesville, VA MSA contains the following areas: Albemarle County, VA; Fluvanna County, VA; Greene County, VA; 
# Nelson County, VA; and Charlottesville city, VA.

Above_median <- c("Renter occupied: $>150k", "Renter occupied: $100k to  $149,999", "Owner occupied: $>150k", "Owner occupied: $100k to  $149,999")
clowincome <- c()
rlowincome <- c()



Tenure_By_Income %>% 
  


    
```



``` {r}

#Ctrl/command + shift + c to comment out all the lines selected
#install.packages("skimr")
#library(skimr)
skimr::skim(ACS_Housing_Data)
#skimr::skim(Poverty_By_Race)
skimr::skim(Tenure_By_Race)


```

```{r}
# ACS_Housing_Data |>
#   group_by(County) |>
#   summarize(medrentest = median(MedianRentE), medrenterror = median(MedianRentM), medtaxest = median(MedianTaxesE), medtaxerror = median(MedianTaxesM), Ratioest = median(RentTaxRatio), Ratioerror = median(RentTaxRatioMOE), avgrentest = mean(MedianRentE), avgrenterror = mean(MedianRentM), avgtaxest = mean(MedianTaxesE), avgtaxerror = mean(MedianTaxesM), avgRatioest = mean(RentTaxRatio), avgRatioerror = mean(RentTaxRatioMOE), med_perc_rent_income = median(PercRent0fIncomeE), med_perc_rent_income_moe = median(PercRent0fIncomeM), avg_perc_rent_income = mean(PercRent0fIncomeE), avg_perc_rent_income_moe = mean(PercRent0fIncomeM), na.rm = TRUE)




```


```{r}


# Do some basic summary statistics: 
# how many renters are there in each census tract? of which demographics?
# What is the average rent, income, and real estate taxes paid in each census tract? 
# What is the average rent to tax ration in each census tract?
# What is the Average percent of rent of income in each census tract? Thus, which census tract is the msot rent burden?
# What does the income and ratio look like there?
# How many are below the poverty level in this tract? and which demographics?
# What is the income distribution in this census tract look like?
# Which census tract has the most students?
# What does the income, and ratio look like there? 
# What are the income distributions in each census tract?
# How does this compare to the average gini index and who's below poverty in each tract?
# Which demographics are most likely to be below poverty and above (or at) in each census tract?


#distrubtion of the rent tax ratio as a whole
ACS_Housing_Data %>% 
  ggplot(aes(ACS_Housing_Data$RentTaxRatio)) + 
  geom_histogram()

#distrubtion of the rent tax ratio by county
ACS_Housing_Data %>% 
  ggplot(aes(ACS_Housing_Data$RentTaxRatio)) + 
  geom_histogram() +
  facet_wrap(~County)

#distrubtion of the rent tax ratio by county (boxplot)
ACS_Housing_Data |>
  ggplot() +
  aes(x = County, y = RentTaxRatio) +
  geom_boxplot() 

#use HUD THAT CLAIBOURNE SHARED WITH US AND look at whos in which income bracket for renter occupied
# Tenure_By_Income %>% 
#   ggplot(aes(Tenure_By_Income$estimate)) + 
#   geom_histogram()


# Based on the answers above, what would be the most useful to visualize? 


```



```{r results = "hide"}
#creating a leaflet map!

#install.packages("tigris")
# library(tigris)

#creating a vector of the counties i need
counties <- c("Albemarle", "Charlottesville", "Fluvanna", "Greene", "Louisa", "Nelson")

#creates a dataframe of the tracts and geographic info in our dataset, can put names or the code numbers for the county argument
countytracts <- tracts(state = "VA", county = counties, year = 2020)
```

``` {r}

#making GEOID numeric so I can join it with ACSHousingData
countytracts <- countytracts |>
  mutate(GEOID = as.numeric(countytracts$GEOID)) 

#joined data, turning into sf object so I can map, remove character strings from the latitude and longitude columns and made them numeric

#by = c("GEOID1" = "GEOID2")


HousingDataSpatial <- full_join(ACS_Housing_Data, countytracts, by = "GEOID") |>
  sf::st_as_sf() |>
  mutate(INTPTLAT = as.numeric(countytracts$INTPTLAT), INTPTLON = as.numeric(countytracts$INTPTLON))|> 
   sf::st_transform(crs = '+proj=longlat +datum=WGS84') #one way to reference a CRS, another way (which Claibourne used) is cvl_rents <- st_transform(cvl_rents, 4326) because leaflet expects the crs to be 4326

# create color palette for shading census tracts
pal <-  colorNumeric("YlOrRd", HousingDataSpatial$RentTaxRatio, reverse = TRUE) #the reverse argument reverses the color palette 
#pal1 <- colorNumeric("Greens", domain = HousingDataSpatial$County, HousingDataSpatial$County)

#creating map and adding layers
leaflet(HousingDataSpatial) %>% 
  addTiles() %>% 
  addPolygons(color = "black",
              fillOpacity = 0.1,
              weight = 2) %>%
  addLabelOnlyMarkers(lng = ~INTPTLON, lat = ~INTPTLAT, label = ~County,
                      labelOptions = labelOptions(noHide = TRUE)) %>% #labels census tracts
  addPolygons(stroke = FALSE, fillOpacity = 0.8, 
              smoothFactor = 0.5, 
              color = ~pal(RentTaxRatio),
              label = ~RentTaxRatio) %>% #to add hovering functionality check what she put for the highlight argument and to add popups, check what she put for the popup argument
  addLegend(pal = pal, 
            values = ~RentTaxRatio, 
            opacity = 0.7, 
            title = "Estimated Rent to Tax Ratio for 2020", 
            position = "bottomleft")




#outlines charlottesville but labels censustracts in another part of the world


#another simple way to graph with sf
#HousingDataSpatial %>% 
#ggplot() +
 # geom_sf(aes(fill = RentTaxRatio)) +
  #geom_sf_label(aes(label = County), size = 3, color = "black", fontface = "bold") +
  #theme_void()




```



```{r}
# ACS_Housing_Data |>
#   filter(County == "Fluvanna")
```

