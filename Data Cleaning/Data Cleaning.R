# Pull data for Rent Exploitation Analysis
# Charlottesville region

library(tidycensus)
library(tidyverse)

# Tract-level Variables from American Community Survey
# Median gross rent: B25064
# Median real estate taxes: B25103
# MEDIAN GROSS RENT AS A PERCENTAGE OF HOUSEHOLD INCOME: B25071 
# Median Household Income: B19013
# Tenure: B25003(s)
# MEDIAN HOUSEHOLD INCOME BY TENURE : B25119 (s)
# TENURE BY HOUSEHOLD INCOME : B25118 
#GINI INDEX: B19083
#educational enrollment: b14007







#(add percent for college studemts, add gini index, draft questions)
# 
# Define region

cvl <- c("003", "540", "079","109", "065", "125", "760", "087", "041", "670", "730")



# Albemarle: 003; Charlottesville: 540; Greene: 079; Louisa: 109; Nelson: 125; Fluvanna: 065
#Richmond City: 760, Henrico County: 087, Chesterfield County: 041, Hopewell City: 670, Petersburg City: 730

vars <- c(MedianRent = "B25064_001", MedianTaxes = "B25103_001", MedianIncome = "B19013_001", PercRentBurden = "B25071_001", Total_Pop = "B14007_001", Undergrad_Pop = "B14007_017", Grad_Pop = "B14007_018")


#tidy output
cvl_rent1 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "tidy")

#wide output
cvl_rent2 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide")


#Table for Tenure by Household Income
TenureByIncome <- get_acs(geography = "tract",
                          table = "B25118",
                          year = 2020,
                          state = "51",
                          survey = "acs5",
                          county = cvl,
                          output = "tidy")

#Table for Income by Tenure
IncomeByTenure <- get_acs(geography = "tract",
                          table = "B25119",
                          year = 2020,
                          state = "51",
                          survey = "acs5",
                          county = cvl,
                          output = "wide")

tvars <- c(Total_Occupants = "B25003_001", Owners = "B25003_002", Renters = "B25003_003")

#Table for Tenure (renter or owner)
Tenure <- get_acs(geography = "tract",
                  variables =  tvars,
                  year = 2020,
                  state = "51",
                  survey = "acs5",
                  county = cvl,
                  output = "wide")

Tenure <- Tenure %>% 
  mutate(County_fips = str_sub(GEOID, 3,5), 
         County = case_when(
           str_detect(GEOID, "51540") ~ "Charlottesville", 
           str_detect(GEOID, "51109") ~ "Louisa",
           str_detect(GEOID, "51125") ~ "Nelson",
           str_detect(GEOID, "51065") ~ "Fluvanna",
           str_detect(GEOID, "51003") ~ "Albemarle",
           str_detect(GEOID, "51079") ~ "Greene",
           str_detect(GEOID, "51760") ~ "Richmond City", 
           str_detect(GEOID, "51087") ~ "Henrico",
           str_detect(GEOID, "51041") ~ "Chesterfield",
           str_detect(GEOID, "51670") ~ "Hopewell",
           str_detect(GEOID, "51730") ~ "Petersburg City"
         ), 
         Region = case_when(
           County_fips %in% cvlcharlottlesville ~ "Charlottesville",
           County_fips %in% cvlrichmond ~ "Richmond"
         ))

racevars <- c(Total_Occupants = "B25003_001", Owners = "B25003_002", Renters = "B25003_003", Whitetotal = "B25003A_001", 
              White_owners = "B25003A_002", White_renters = "B25003A_003", Black_owners = "B25003B_002",
              Black_renters = "B25003B_003", NativeAm_owners = "B25003C_002", NativeAm_renters = "B25003C_003", 
              Asian_owners = "B25003D_002", Asian_renters = "B25003D_003", PacificIslander_owner = "B25003E_002", 
              PacificIslander_renter = "B25003E_003", HispanicLatino_owner = "B25003I_002", 
              HispanicLation_renter = "B25003I_003", BlackTotal = "B25003B_001", AsianTotal = "B25003D_001", 
              NativeAmTotal = "B25003C_001", PacificIslanderTotal = "B25003E_001", HispanicLatinoTotal = "B25003I_001")
TenureByRace <- get_acs(geography = "tract",
                  variables = racevars,
                  year = 2020,
                  state = "51",
                  survey = "acs5",
                  county = cvl,
                  output = "wide")


#Gini Index Table also included
Povertyvars <- c(Total = "B17020_001", Total_BelowPoverty = "B17020_002", Total_AbovePoverty = "B17020_010", BelowPoverty_White = "B17020A_002", AbovePoverty_White = "B17020A_010", BelowPoverty_Black = "B17020B_002",
                 AbovePoverty_Black = "B17020B_010", BelowPoverty_NativeAm = "B17020C_002", AbovePoverty_NativeAm = "B17020C_010", 
                 BelowPoverty_Asian = "B17020D_002", AbovePoverty_Asian = "B17020D_010", BelowPoverty_PacificIslander = "B17020E_002", 
                AbovePoverty_PacificIslander = "B17020E_010", BelowPoverty_HispanicLatino = "B17020I_002", 
                AbovePoverty_HispanicLatino = "B17020I_010", Gini_Index = "B19083_001")
PovertyByRace <- get_acs(geography = "tract",
                         variables = Povertyvars,
                         year = 2020,
                         state = "51",
                         survey = "acs5",
                         county = cvl,
                         output = "wide")

PovertyByRace <- PovertyByRace %>%
  mutate(Perc_BelowPoverty_WhiteE = round((BelowPoverty_WhiteE/(BelowPoverty_WhiteE + AbovePoverty_WhiteE))*100, 2),
         Perc_BelowPoverty_BlackE = round((BelowPoverty_BlackE/(BelowPoverty_BlackE + AbovePoverty_BlackE))*100, 2),
         Perc_BelowPoverty_AsianE = round((BelowPoverty_AsianE/(BelowPoverty_AsianE + AbovePoverty_AsianE))*100, 2),
         Perc_BelowPoverty_PacificIslanderE = round((BelowPoverty_PacificIslanderE/(BelowPoverty_PacificIslanderE + AbovePoverty_PacificIslanderE))*100, 2),
         Perc_BelowPoverty_NativeAmE = round((BelowPoverty_NativeAmE/(BelowPoverty_NativeAmE + AbovePoverty_NativeAmE))*100, 2),
         Perc_BelowPoverty_HispanicLatinoE = round((BelowPoverty_HispanicLatinoE/(BelowPoverty_HispanicLatinoE + AbovePoverty_HispanicLatinoE))*100, 2),
         Perc_BelowPoverty_WhiteM = round((BelowPoverty_WhiteM/(BelowPoverty_WhiteM + AbovePoverty_WhiteM))*100, 2),
         Perc_BelowPoverty_BlackM = round((BelowPoverty_BlackM/(BelowPoverty_BlackM + AbovePoverty_BlackM))*100, 2),
         Perc_BelowPoverty_AsianM = round((BelowPoverty_AsianM/(BelowPoverty_AsianM + AbovePoverty_AsianM))*100, 2),
         Perc_BelowPoverty_PacificIslanderM = round((BelowPoverty_PacificIslanderM/(BelowPoverty_PacificIslanderM + AbovePoverty_PacificIslanderM))*100, 2),
         Perc_BelowPoverty_NativeAmM = round((BelowPoverty_NativeAmM/(BelowPoverty_NativeAmM + AbovePoverty_NativeAmM))*100, 2),
         Perc_BelowPoverty_HispanicLatinoM = round((BelowPoverty_HispanicLatinoM/(BelowPoverty_HispanicLatinoM + AbovePoverty_HispanicLatinoM))*100, 2), 
         Perc_Total_BelowPovertyE = round((Total_BelowPovertyE/TotalE)*100, 2)) 





# Wrangling
# rename variables
# create rent/tax ratio
# add variable for locality: str_contains
# save/output prepped data
# Try reading in exported data to R markdown
# Basic exploration of data 



#chanigng column names, creating rent/tax ratio, adding new column for county, reording columns

cvlcharlottlesville <- c("003", "540", "079","109", "065", "125")
cvlrichmond <- c("760", "087", "041", "670", "730")

cvl_rent2 <- cvl_rent2 |>
  mutate(RentTaxRatio = MedianRentE/MedianTaxesE, 
         RentTaxRatioMOE = moe_ratio(MedianRentE, MedianTaxesE, MedianRentM, MedianTaxesM),
         County_fips = str_sub(GEOID, 3,5), 
         County = case_when(
    str_detect(GEOID, "51540") ~ "Charlottesville", 
    str_detect(GEOID, "51109") ~ "Louisa",
    str_detect(GEOID, "51125") ~ "Nelson",
    str_detect(GEOID, "51065") ~ "Fluvanna",
    str_detect(GEOID, "51003") ~ "Albemarle",
    str_detect(GEOID, "51079") ~ "Greene",
    str_detect(GEOID, "51760") ~ "Richmond City", 
    str_detect(GEOID, "51087") ~ "Henrico",
    str_detect(GEOID, "51041") ~ "Chesterfield",
    str_detect(GEOID, "51670") ~ "Hopewell",
    str_detect(GEOID, "51730") ~ "Petersburg City"
  ), 
  Region = case_when(
    County_fips %in% cvlcharlottlesville ~ "Charlottesville",
    County_fips %in% cvlrichmond ~ "Richmond"
  ),
  Perc_StudentsE = round(((Undergrad_PopE + Grad_PopE)/(Total_PopE))*100, 2),
  Perc_StudentsM = round(((Undergrad_PopM + Grad_PopM)/(Total_PopM))*100, 2))|>
  select(1, 19, 2, 20, 21, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 22, 23)

#cvl_rent2 <- cvl_rent2 %>% 
 # select(1, 13, 2, 14, 15, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12)


TenureByRace <- TenureByRace %>% 
  mutate(County_fips = str_sub(GEOID, 3,5), 
County = case_when(
  str_detect(GEOID, "51540") ~ "Charlottesville", 
  str_detect(GEOID, "51109") ~ "Louisa",
  str_detect(GEOID, "51125") ~ "Nelson",
  str_detect(GEOID, "51065") ~ "Fluvanna",
  str_detect(GEOID, "51003") ~ "Albemarle",
  str_detect(GEOID, "51079") ~ "Greene",
  str_detect(GEOID, "51760") ~ "Richmond City", 
  str_detect(GEOID, "51087") ~ "Henrico",
  str_detect(GEOID, "51041") ~ "Chesterfield",
  str_detect(GEOID, "51670") ~ "Hopewell",
  str_detect(GEOID, "51730") ~ "Petersburg City"
), 
Region = case_when(
  County_fips %in% cvlcharlottlesville ~ "Charlottesville",
  County_fips %in% cvlrichmond ~ "Richmond"
)) |>
  select(1, 45, 2, 46, 47, 3:44)

PovertyByRace <- PovertyByRace %>% 
  mutate(County_fips = str_sub(GEOID, 3,5), 
         County = case_when(
           str_detect(GEOID, "51540") ~ "Charlottesville", 
           str_detect(GEOID, "51109") ~ "Louisa",
           str_detect(GEOID, "51125") ~ "Nelson",
           str_detect(GEOID, "51065") ~ "Fluvanna",
           str_detect(GEOID, "51003") ~ "Albemarle",
           str_detect(GEOID, "51079") ~ "Greene",
           str_detect(GEOID, "51760") ~ "Richmond City", 
           str_detect(GEOID, "51087") ~ "Henrico",
           str_detect(GEOID, "51041") ~ "Chesterfield",
           str_detect(GEOID, "51670") ~ "Hopewell",
           str_detect(GEOID, "51730") ~ "Petersburg City"
         ), 
         Region = case_when(
           County_fips %in% cvlcharlottlesville ~ "Charlottesville",
           County_fips %in% cvlrichmond ~ "Richmond"
         )) |>
  select(1,48, 2, 49, 50, 3:47)



cvl_rent2$MedianIncomeE <- IncomeByTenure$B25119_003E
cvl_rent2$MedianIncomeM <- IncomeByTenure$B25119_003M


v20 <- load_variables(2020, "acs5", cache = TRUE)
TenureByIncome <- v20 %>% 
  filter(str_detect(name, "B25118")) %>% 
  full_join(TenureByIncome, v20, by = c("name" = "variable")) %>% 
  select(1,2,5,6,7,8) 

TenureByIncome <- TenureByIncome %>% 
  mutate(County = case_when(
    str_detect(GEOID, "51540") ~ "Charlottesville", 
    str_detect(GEOID, "51109") ~ "Louisa",
    str_detect(GEOID, "51125") ~ "Nelson",
    str_detect(GEOID, "51065") ~ "Fluvanna",
    str_detect(GEOID, "51003") ~ "Albemarle",
    str_detect(GEOID, "51079") ~ "Greene",
    str_detect(GEOID, "51760") ~ "Richmond City", 
    str_detect(GEOID, "51087") ~ "Henrico",
    str_detect(GEOID, "51041") ~ "Chesterfield",
    str_detect(GEOID, "51670") ~ "Hopewell",
    str_detect(GEOID, "51730") ~ "Petersburg City"
  )) |>
  select(3, 4, 7, 1, 2, 5, 6)

cvlcharlottlesville <- c("003", "540", "079","109", "065", "125")
cvlrichmond <- c("760", "087", "041", "670", "730")



TenureByIncome <- TenureByIncome %>% 
  mutate(County_fips = str_sub(GEOID, 3,5),
         label = case_when( 
           label %in% "Estimate!!Total:!!Renter occupied:!!$150,000 or more" ~ "Renter occupied: $>150k", 
           label %in% "Estimate!!Total:!!Renter occupied:!!$100,000 to $149,999" ~ "Renter occupied: $100k to  $149,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$75,000 to $99,999" ~ "Renter occupied: $75k to $99,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$50,000 to $74,999" ~ "Renter occupied: $50k to $74,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$35,000 to $49,999" ~ "Renter occupied: $35k to $49,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$25,000 to $34,999" ~ "Renter occupied: $25k to $34,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$20,000 to $24,999" ~ "Renter occupied: $20k to $24,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$15,000 to $19,999" ~ "Renter occupied: $15k to $19,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$10,000 to $14,999" ~ "Renter occupied: $10k to $14,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!$5,000 to $9,999" ~ "Renter occupied: $5k to $9,999",
           label %in% "Estimate!!Total:!!Renter occupied:!!Less than $5,000" ~ "Renter occupied: <$5k",    
           label %in% "Estimate!!Total:!!Renter occupied:" ~ "Renter Occupied",
           label %in% "Estimate!!Total:!!Owner occupied:!!$150,000 or more" ~ "Owner occupied: $>150k",
           label %in% "Estimate!!Total:!!Owner occupied:!!$100,000 to $149,999" ~ "Owner occupied: $100k to  $149,999", 
           label %in% "Estimate!!Total:!!Owner occupied:!!$75,000 to $99,999" ~ "Owner occupied: $75k to $99,999",
           label %in% "Estimate!!Total:!!Owner occupied:!!$50,000 to $74,999" ~ "Owner occupied: $50k to $74,999",
           label %in% "Estimate!!Total:!!Owner occupied:!!$35,000 to $49,999" ~ "Owner occupied: $35k to $49,999",      
           label %in% "Estimate!!Total:!!Owner occupied:!!$25,000 to $34,999" ~ "Owner occupied: $25k to $34,999",
           label %in% "Estimate!!Total:!!Owner occupied:!!$20,000 to $24,999" ~ "Owner occupied: $20k to $24,999",
           label %in% "Estimate!!Total:!!Owner occupied:!!$15,000 to $19,999" ~ "Owner occupied: $15k to $19,999",
           label %in% "Estimate!!Total:!!Owner occupied:!!$10,000 to $14,999" ~ "Owner occupied: $10k to $14,999",
           label %in% "Estimate!!Total:!!Owner occupied:!!$5,000 to $9,999" ~ "Owner occupied: $5k to $9,999",
           label %in% "Estimate!!Total:!!Owner occupied:!!Less than $5,000" ~ "Owner occupied: <$5k",
           label %in% "Estimate!!Total:!!Owner occupied:" ~ "Owner Occupied",
           label %in% "Estimate!!Total:" ~ "Total"),
         Region = case_when(
           County_fips %in% cvlcharlottlesville ~ "Charlottesville",
           County_fips %in% cvlrichmond ~ "Richmond")
  )  %>% 
  rename(Variable_Code = name, Variable = label) %>% 
  select(1, 8, 2, 3, 9, 4, 5, 6, 7)

charlottesvillemsa <- c("003", "540", "079", "065", "125")

Above_median <- c("Renter occupied: $>150k", "Renter occupied: $100k to  $149,999", "Owner occupied: $>150k", "Owner occupied: $100k to  $149,999")
lowincome <- c("Renter occupied: $50k to $74,999", "Owner occupied: $50k to $74,999")
very_lowincome <- c("Renter occupied: $35k to $49,999", "Owner occupied: $35k to $49,999")
extremely_lowincome <- c("Renter occupied: $25k to $34,999", "Renter occupied: $20k to $24,999", "Owner occupied: $25k to $34,999", "Owner occupied: $20k to $24,999")
below_avgpovertylvl <- c("Renter occupied: $15k to $19,999", "Renter occupied: $10k to $14,999", "Renter occupied: $5k to $9,999", "Renter occupied: <$5k", "Owner occupied: $15k to $19,999", "Owner occupied: $10k to $14,999", "Owner occupied: $5k to $9,999", "Owner occupied: <$5k")




#Average HOUSEHOLD SIZE OF OCCUPIED HOUSING UNITS BY TENURE (RENTER OCCUPIED)
Householdsize <- get_acs(geography = "tract",
                  variables = "B25010_003",
                  year = 2020,
                  state = "51",
                  survey = "acs5",
                  county = cvl,
                  output = "wide")

Householdsize <- Householdsize %>% 
  mutate(County_fips = str_sub(GEOID, 3,5),
         Region = case_when(
           County_fips %in% cvlcharlottlesville ~ "Charlottesville",
           County_fips %in% cvlrichmond ~ "Richmond")
  ) %>% 
  rename(SizeE = B25010_003E, SizeM = B25010_003M)

Householdsize %>% 
  group_by(Region) %>% 
  summarize(MedSize = median(SizeE, na.rm = TRUE), AvgSize = median(SizeE, na.rm = TRUE))


write.csv(cvl_rent2, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Housing_Data.csv", row.names = FALSE)
write.csv(IncomeByTenure, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Income_By_Tenure.csv", row.names = FALSE)
write.csv(Tenure, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenure.csv", row.names = FALSE)
write.csv(TenureByIncome, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenure_By_Income.csv", row.names = FALSE)
write.csv(TenureByRace, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Tenurebyrace.csv", row.names = FALSE)
write.csv(PovertyByRace, "C:/Users/smang/OneDrive/Housing Justice DJA/rentexploitationproject/Data Cleaning/Povertybyrace.csv", row.names = FALSE)


