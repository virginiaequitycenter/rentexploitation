# Pull data for Rent Exploitation Analysis
# Charlottesville region

library(tidycensus)
library(tidyverse)

# Tract-level Variables from American Community Survey
# Median gross rent: B25064
# Median real estate taxes: B25103

# Define region
cvl <- c("003", "540", "079","109", "065", "125")
# Albemarle: 003; Charlottesville: 540; Greene: 079; Louisa: 109; Nelson: 125; Fluvanna: 065
rva <- c("670", "730", "760", "041", "087")

vars <- c(medrent = "B25064_001", medtax = "B25103_001") # mpc revised

cvl_rent1 <- get_acs(geography = "tract",
                    variables = vars,
                    year = 2020,
                    state = "51",
                    survey = "acs5",
                    county = cvl,
                    output = "tidy")

cvl_rent2 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide")

rva_rent1 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = rva,
                     output = "tidy")

rva_rent2 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = rva,
                     output = "wide")

# Wrangling
# rename variables
# cvl_rent2 <- rename(cvl_rent2, MedTaxEst= MedTaxMOE ,MedTaxMOE = MedTaxEst)

# create rent/tax ratio
cvl_rent2 <- cvl_rent2 %>% 
  mutate(rent_tax_ratio = medrentE/medtaxE,
         rent_tax_ratio_moe = moe_ratio(medrentE, medtaxE, medrentM, medtaxM))

rva_rent2 <- rva_rent2 %>% 
  mutate(rent_tax_ratio = medrentE/medtaxE,
         rent_tax_ratio_moe = moe_ratio(medrentE, medtaxE, medrentM, medtaxM))

# add variable for locality: str_contains
cvl_rent2 <- cvl_rent2 %>% 
  mutate(county_fips = str_sub(GEOID, 3,5),
         county_tract = str_sub(GEOID, 3,11)) %>% 
  mutate(county = case_when(
    county_fips == "540" ~ "Charlottesville",
    county_fips == "003" ~ "Albemarle",
    county_fips == "065" ~ "Fluvanna",
    county_fips == "079" ~ "Greene",
    county_fips == "109" ~ "Louisa",
    county_fips == "125" ~ "Nelson"
  ))

rva_rent2 <- rva_rent2 %>% 
  mutate(county_fips = str_sub(GEOID, 3,5),
         county_tract = str_sub(GEOID, 3,11)) %>% 
  mutate(county = case_when(
    county_fips == "760" ~ "Richmond",
    county_fips == "730" ~ "Petersburg",
    county_fips == "670" ~ "Hopewell",
    county_fips == "041" ~ "Chesterfield",
    county_fips == "087" ~ "Henrico"
  ))

# save/output prepped data
saveRDS(cvl_rent2, file = "cvl_rent.RDS")
saveRDS(rva_rent2, file = "rva_rent.RDS")

# Try reading in exported data to R markdown
# and generate data exploration to share 

