# Segregation Measures
# non-spatial dissimilarity and isolation
# July 2022, mpc

# 1. Set up ----
library(tidyverse)

# Get Cville region redistricting data
cvl <- c("003", "540", "079","109", "065", "125")
rva <- c("760", "670", "730", "087", "041")

cr <- readRDS("seg/census2020.RDS")
# generated with R Versions/pl_all_4_2020_dar.r
# from: https://www.census.gov/data/datasets/2020/dec/2020-census-redistricting-summary-file-dataset.html

# keep cville region and richmong region block data
cvl_cr <- cr %>% 
  filter(COUNTY %in% cvl)

rva_cr <- cr %>% 
  filter(COUNTY %in% rva)

rm(cr)


# 2. Calculate dissimilarity/isolation for tracts ----
# interpretation/calculation of dissimilarity and isolation
#   https://rstudio-pubs-static.s3.amazonaws.com/473785_e782a2a8458d4263ba574c7073ca5057.html
## Charlottesville region ----
# tracts as larger reference area
cvl_cr_tract <- cvl_cr %>% 
  filter(SUMLEV == "140") %>% # 140 represents tract level
  select(GEOID, GEOCODE, COUNTY, TRACT,
         area_total = P0010001, 
         area_white_alone = P0010003, 
         area_black_alone = P0010004) %>% 
  mutate(county_tract = paste0(COUNTY, TRACT),
         area_total = as.numeric(area_total),
         area_white_alone = as.numeric(area_white_alone),
         area_black_alone = as.numeric(area_black_alone))

# filter for block data
cvl_cr_block <- cvl_cr %>% 
  filter(SUMLEV == "750") %>% 
  select(GEOID, GEOCODE, COUNTY, TRACT, BLKGRP, BLOCK,
    block_total = P0010001, 
    white_alone = P0010003, 
    black_alone = P0010004) %>% 
  mutate(county_tract = paste0(COUNTY, TRACT), # make combined county tract for merging
         block_total = as.numeric(block_total),
         white_alone = as.numeric(white_alone),
         black_alone = as.numeric(black_alone))

# join tract totals to block data
cvl_cr_block <- cvl_cr_block %>% 
  left_join(cvl_cr_tract, by = "county_tract")

# generate seg measures
# dissimilarity
dissim_wb_block <- cvl_cr_block %>%
  mutate(d.wb = abs(white_alone/area_white_alone - black_alone/area_black_alone)) %>%
  group_by(county_tract) %>%
  summarise(dissim_wb_block = .5*sum(d.wb, na.rm=T))

# ggplot(dissim_wb_block, aes(x = dissim_wb_block)) +
#   geom_histogram()

# isolation
iso_b_block <- cvl_cr_block %>%
  mutate(iso_b=(black_alone/area_black_alone * black_alone/block_total) )%>%
  group_by(county_tract) %>%
  summarise(iso_b_block = sum(iso_b, na.rm=T))

# ggplot(iso_b_block, aes(x = iso_b_block)) +
#   geom_histogram()

# Join and compare
seg_cvl <- left_join(dissim_wb_block, iso_b_block) %>% 
  mutate(region = "cvl")

# ggplot(seg_cvl, aes(x = dissim_wb_block, y = iso_b_block)) +
#   geom_point()


## Richmond region ----
# tracts as larger reference area
rva_cr_tract <- rva_cr %>% 
  filter(SUMLEV == "140") %>% 
  select(GEOID, GEOCODE, COUNTY, TRACT,
         area_total = P0010001, 
         area_white_alone = P0010003, 
         area_black_alone = P0010004) %>% 
  mutate(county_tract = paste0(COUNTY, TRACT),
         area_total = as.numeric(area_total),
         area_white_alone = as.numeric(area_white_alone),
         area_black_alone = as.numeric(area_black_alone))

# filter for block data
rva_cr_block <- rva_cr %>% 
  filter(SUMLEV == "750") %>% 
  select(GEOID, GEOCODE, COUNTY, TRACT, BLKGRP, BLOCK,
         block_total = P0010001, 
         white_alone = P0010003, 
         black_alone = P0010004) %>% 
  mutate(county_tract = paste0(COUNTY, TRACT),
         block_total = as.numeric(block_total),
         white_alone = as.numeric(white_alone),
         black_alone = as.numeric(black_alone))

# join tract totals
rva_cr_block <- rva_cr_block %>% 
  left_join(rva_cr_tract, by = "county_tract") 

# generate seg measures
# dissimilarity
dissim_wb_block_rva <- rva_cr_block %>%
  mutate(d.wb = abs(white_alone/area_white_alone - black_alone/area_black_alone)) %>%
  group_by(county_tract) %>%
  summarise(dissim_wb_block = .5*sum(d.wb, na.rm=T))

# ggplot(dissim_wb_block_rva, aes(x = dissim_wb_block)) +
#   geom_histogram()

# isolation
iso_b_block_rva <- rva_cr_block %>%
  mutate(iso_b=(black_alone/area_black_alone * black_alone/block_total) )%>%
  group_by(county_tract) %>%
  summarise(iso_b_block = sum(iso_b, na.rm=T))

# ggplot(iso_b_block_rva, aes(x = iso_b_block)) +
#   geom_histogram()

# Join and compare
seg_rva <- left_join(dissim_wb_block_rva, iso_b_block_rva) %>% 
  mutate(region = "rva")

# ggplot(seg_rva, aes(x = dissim_wb_block, y = iso_b_block)) +
#   geom_point()

## Bind two region and compare ----
seg_all <- rbind(seg_cvl, seg_rva)

ggplot(seg_all, aes(x = dissim_wb_block)) +
  geom_histogram() +
  facet_wrap(~region, scales = "free_y")

ggplot(seg_all, aes(x = iso_b_block)) +
  geom_histogram() +
  facet_wrap(~region, scales = "free_y")

ggplot(seg_all, aes(x = dissim_wb_block, y = iso_b_block)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~region)


# 3. Save ----
saveRDS(seg_all, "seg/cvl_rva_measures.RDS")
write_csv(seg_all, "seg/cvl_rva_measures.csv")
