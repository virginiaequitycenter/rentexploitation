census_api_key("458aa9bc797be35b8c9b994f1c9b9760f35a8c1a", install = TRUE, overwrite = TRUE )
readRenviron("~/.Renviron")

# Pull data for Rent Exploitation Analysis
# Charlottesville region
library(tidycensus)
library(tidyverse)
library(leaflet)



# Tract-level Variables from American Community Survey
# Median gross rent: B25064
# Median real estate taxes: B25103

# Define region
cvl <- c("003", "540", "079","109", "065", "125", "760", "087","041", "670", "730")
#Charlottesville Region Fips: Albemarle: 003; Charlottesville: 540; Greene: 079; Louisa: 109; Nelson: 125; Fluvanna: 065
#Richmond Region Fips: Richmond City: 760; Henrico County: 087; Chesterfield County: 041; Hopewell City: 670; Petersburg City: 730

vars <- c(MedRent="B25064_001", MedTax="B25103_001", MedRenterHHIncome="B25119_003",MedHHIncome="B19013_001", WhiteMedHHIncome="B19013A_001", BlackMedHHIncome="B19013B_001", NatAmerMedHHIncome="B19013C_001", AsianMedHHIncome="B19013D_001", PacIslMedHHIncome="B19013E_001", HispanicLatinoMedHHIncome="B19013I_001", MedRentBurdenPerc="B25071_001")
#B25071 MedianGross rent as percentage of household income
#B25077 MEDIAN VALUE (DOLLARS)
#B25121  HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2020 INFLATION-ADJUSTED DOLLARS) BY VALUE
#B25106  TENURE BY HOUSING COSTS AS A PERCENTAGE OF HOUSEHOLD INCOME IN THE PAST 12 MONTHS
#B25118  TENURE BY HOUSEHOLD INCOME IN THE PAST 12 MONTHS (IN 2020 INFLATION-ADJUSTED DOLLARS)
#B25003  TENURE
#Additional Variables
  #B160016 LANGUAGE SPOKEN AT HOME BY ABILITY TO SPEAK ENGLISH FOR THE POPULATION 5 YEARS AND OVER (HISPANIC OR LATINO)
  #B19083 Gini Index of Income Inequality - 
  #B14007 SCHOOL ENROLLMENT BY DETAILED LEVEL OF SCHOOL FOR THE POPULATION 3 YEARS AND OVER (_17 Undergrad, _18 Grad Program)
  #B02001 Race
  #S1701  POVERTY STATUS IN THE PAST 12 MONTHS
  #B99163  ALLOCATION OF ABILITY TO SPEAK ENGLISH FOR THE POPULATION 5 YEARS AND OVER
  #B16009  POVERTY STATUS IN THE PAST 12 MONTHS BY AGE BY LANGUAGE SPOKEN AT HOME FOR THE POPULATION 5 YEARS AND OVER
  #S1602  LIMITED ENGLISH SPEAKING HOUSEHOLDS





cvl_rent1 <- get_acs(geography = "tract",
                    variables = vars,
                    year = 2020,
                    state = "51",
                    survey = "acs5",
                    county = cvl,
                    output = "tidy")

ACSData2020 <- get_acs(geography = "tract",
                     variables = vars,
                     year = 2020,
                     state = "51",
                     survey = "acs5",
                     county = cvl,
                     output = "wide")

# rename variables
  
#ACSData2020 <- rename(ACSData2020,MedRentEst= B25064_001E, MedRentMOE = B25064_001M, MedTaxEst= B25103_001E, MedTaxMOE = B25103_001M,MedHHIncomeEst=B19013_001M, MedHHIncomeMOE=B19013_001M)
# create rent/tax ratio
ACSData2020 <- ACSData2020 %>% 
  mutate(RentTaxRatE= MedRentE/MedTaxE , 
         RentTaxRatMOE= moe_ratio(MedRentE,MedTaxE, MedRentM, MedTaxM))



# add variable for locality: str_contains
ACSData2020<- ACSData2020 %>%
  mutate(FipCodes=str_sub(GEOID,3,5)) %>% 
  mutate(County = case_when(
    FipCodes=="540"~"Charlottesville",
    FipCodes=="109"~"Louisa",
    FipCodes=="125"~"Nelson",
    FipCodes=="065"~"Fluvanna",
    FipCodes=="003"~"Albemarle",
    FipCodes=="079"~"Greene",
    FipCodes=="760"~"Richmond City",
    FipCodes=="087"~"Henrico County",
    FipCodes=="041"~"Chesterfield County", 
    FipCodes=="670"~"Hopewell City", 
    FipCodes=="730"~"Petersburg City"
    
  ))

ACSData2020<-ACSData2020 %>% 
  mutate(Region=case_when(
    FipCodes %in% c("540","109","125", "065", "003", "079")~"Charlottesville",
    FipCodes %in% c("760","087","041", "670", "730")~"Richmond"
  ))

#ordering the columns to place "County" next to "GEOID"
ACSData2020 <- select(ACSData2020, 1, 2, 27:29, 3:6, 25, 26, 7, 8, 23, 24, 9:22)

#creating tenure dataset
# Tenure <- get_acs(geography = "tract",
#                      table = "B25003", 
#                      year = 2020,
#                     state = "51",
#                      survey = "acs5",
#                      county = cvl,
#                      output = "wide",)
# Tenure <- rename(Tenure, TotalHHE="B25003_001E", TotalHHMOE="B25003_001M",OwnerOcE="B25003_002E", OwnerOcMOE="B25003_002M",RenterOcE="B25003_003E", RenterOcMOE="B25003_003M")
# Tenure<- Tenure %>%
#   mutate(FipCodes=str_sub(GEOID,3,5)) %>% 
#   mutate(County = case_when(
#     FipCodes=="540"~"Charlottesville",
#     FipCodes=="109"~"Louisa",
#     FipCodes=="125"~"Nelson",
#     FipCodes=="065"~"Fluvanna",
#     FipCodes=="003"~"Albemarle",
#     FipCodes=="079"~"Greene",
#     FipCodes=="760"~"Richmond City",
#     FipCodes=="087"~"Henrico County",
#     FipCodes=="041"~"Chesterfield County", 
#     FipCodes=="670"~"Hopewell City", 
#     FipCodes=="730"~"Petersburg City"
#     
#   ))
# 
# Tenure<-Tenure %>% 
#   mutate(Region=case_when(
#     FipCodes %in% c("540","109","125", "065", "003", "079")~"Charlottesville",
#     FipCodes %in% c("760","087","041", "670", "730")~"Richmond"
#   ))
# 
# Tenure<-select(Tenure,c(1,2, 11, 10, 9, 3, 4, 5, 6, 7, 8))

#creating tenure  and tenure by race dataset
racevars<-c(TotalHH="B25003_001", TotalOwnerOc="B25003_002",TotalRenterOc="B25003_003",
            WhiteOwners="B25003A_002", WhiteRenters="B25003A_003", BlackOwners="B25003B_002", BlackRenters="B25003B_003", 
            NativeAmOwners="B25003C_002", NativeAmRenters="B25003C_003", AsianOwners="B25003D_002", AsianRenters="B25003D_003", 
            PacificIslandOwners="B25003E_002", PacificIslandRenters="B25003E_003", HispanicLatinoOwners="B25003I_002", HispanicLatinoRenters="B25003I_003")
TenureByRace<-get_acs(geography = "tract",
                      variables= racevars,
                      year = 2020,
                      state = "51",
                      survey = "acs5",
                      county = cvl,
                      output = "wide",)
TenureByRace<- TenureByRace %>%
  mutate(FipCodes=str_sub(GEOID,3,5)) %>% 
  mutate(County = case_when(
    FipCodes=="540"~"Charlottesville",
    FipCodes=="109"~"Louisa",
    FipCodes=="125"~"Nelson",
    FipCodes=="065"~"Fluvanna",
    FipCodes=="003"~"Albemarle",
    FipCodes=="079"~"Greene",
    FipCodes=="760"~"Richmond City",
    FipCodes=="087"~"Henrico County",
    FipCodes=="041"~"Chesterfield County", 
    FipCodes=="670"~"Hopewell City", 
    FipCodes=="730"~"Petersburg City"
  ))

TenureByRace<-TenureByRace %>% 
  mutate(Region=case_when(
    FipCodes %in% c("540","109","125", "065", "003", "079")~"Charlottesville",
    FipCodes %in% c("760","087","041", "670", "730")~"Richmond"
  ))
TenureByRace<- TenureByRace %>% 
  mutate(PercOfBlkRenters=(BlackRentersE/TotalRenterOcE)*100) %>% 
  mutate(PercOfWhtRenters=(WhiteRentersE/TotalRenterOcE)*100) %>% 
  mutate(PercOfNaAmRenters=(NativeAmRentersE/TotalRenterOcE)*100) %>% 
  mutate(PercOfAsnRenters=(AsianRentersE/TotalRenterOcE)*100) %>% 
  mutate(PercOfPaIsRenters=(PacificIslandRentersE/TotalRenterOcE)*100) %>% 
  mutate(PercOfHisLatRenters=(HispanicLatinoRentersE/TotalRenterOcE)*100)
  
  
TenureByRace<-select(TenureByRace,c(1, 2, 35, 34, 33, 3:12, 37, 13:16, 36, 17:20, 38, 21:24,39, 25:28, 40, 29:32, 41))


#loading poverty by race dataset
#total is not a proper representation of total population (B01003  TOTAL POPULATION) as it is the "population for whom povery status is determined" (B17020  POVERTY STATUS IN THE PAST 12 MONTHS BY AGE)
povertyvars<-c(TotalPop="B17020_001", PovTotal= "B17020_002", AbovePovTotal="B17020_010", IncomeInequality="B19083_001",
               WhiteTotal="S1701_C01_013", WhitePovertyTotal="S1701_C02_013", WhiteAbove= "B17020A_010",  WhitePovertyPerc="S1701_C03_013",
               BlackTotal="S1701_C01_014", BlackPovertyTotal="S1701_C02_014", BlackAbove= "B17020B_010", BlackPovertyPerc="S1701_C03_014",
               NativeAmerTotal="S1701_C01_015", NativeAmerPovertyTotal="S1701_C02_015", NativeAmerAbove= "B17020C_010", NativeAmerPovertyPerc="S1701_C03_015", 
               AsianTotal="S1701_C01_016", AsianPovertyTotal="S1701_C02_016", AsianAbove= "B17020D_010", AsianPovertyPerc="S1701_C03_016",
               PacificIsTotal="S1701_C01_017", PacificIsPovertyTotal="S1701_C02_017", PacificIsAbove= "B17020E_010", PacificIsPovertyPerc="S1701_C03_017", 
               OtherRacesTotal="S1701_C01_018", OtherRacesPovertyTotal="S1701_C02_018", OtherRacesAbove= "B17020F_010", OtherRacesPovertyPerc="S1701_C03_018", 
               HispanicLatinoTotal="S1701_C01_020", HispanicLatinoPovertyTotal="S1701_C02_020", HispanicLatinoAbove= "B17020I_010", HispanicLatinoPovertyPerc="S1701_C03_020")
PovertybyRace<-get_acs(geography = "tract",
                      variables= povertyvars,
                      year = 2020,
                      state = "51",
                      survey = "acs5",
                      county = cvl,
                      output = "wide",)
PovertybyRace<- PovertybyRace %>%
  mutate(FipCodes=str_sub(GEOID,3,5)) %>% 
  mutate(County = case_when(
    FipCodes=="540"~"Charlottesville",
    FipCodes=="109"~"Louisa",
    FipCodes=="125"~"Nelson",
    FipCodes=="065"~"Fluvanna",
    FipCodes=="003"~"Albemarle",
    FipCodes=="079"~"Greene",
    FipCodes=="760"~"Richmond City",
    FipCodes=="087"~"Henrico County",
    FipCodes=="041"~"Chesterfield County", 
    FipCodes=="670"~"Hopewell City", 
    FipCodes=="730"~"Petersburg City"
    
  ))

PovertybyRace<-PovertybyRace %>% 
  mutate(Region=case_when(
    FipCodes %in% c("540","109","125", "065", "003", "079")~"Charlottesville",
    FipCodes %in% c("760","087","041", "670", "730")~"Richmond"
  ))

PovertybyRace<-select(PovertybyRace,c(1, 2, 69, 68, 67, 3:10, 25, 26, 11, 12, 27:32, 13, 14, 33:38, 15, 16, 39:44, 17, 18, 45:50, 19, 20, 51:56, 21, 22, 57:62, 23, 24, 63:66))

#draft questions
# try to find general poverty,
#add education enrollment
              




# save/output prepped data

write.csv(ACSData2020,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/ACSData2020.csv", row.names=FALSE)
#write.csv(Tenure,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/TenureData.csv", row.names=FALSE)
write.csv(TenureByRace,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/TenureByRaceData.csv", row.names=FALSE)
write.csv(PovertybyRace,"~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/PovertybyRaceData.csv", row.names=FALSE)

#/UVA Data Justice/rentexploitationproj/KaylaRStudioWork/
#~/UVA Data Justice/rentexploitationproj/KaylaRStudioWork

# Try reading in exported data to R markdown
# Basic exploration of data 

CensusHousingData %>% 
  ggplot()+
  geom_sf(aes(fill= RentTaxRatE))+
  geom_sf_label(aes(label = County), size=3, color ="black", fontface = "bold")+
  theme_void()
  
ggplot(cvl_rents)+
  geom_sf(aes(fill=rent))

ACSData2020 <- st_transform(ACSData2020, 4326)

# basic leaflet map
leaflet(ACSData2020) %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons()

