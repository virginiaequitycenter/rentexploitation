---
title: "Rent Exploitation Final Markdown"
author: "Kayla Campbell"
date: '2022-07-06'
output: html_document
---
Intro on the history of Charlottesville...
         the housing market...
         renter explotation...
         
Loading packages for exploration
```{r}
library(readr)
library(leaflet)
library(ggplot2)
library(GGally)
library(dplyr)
library(scales)
library(tidyverse)
library(tigris)
library(sf)
library(viridis)
library(RColorBrewer)
```


```{r}
# Reading in exported data to R markdown
library(readr)
ACSData2020 <- read_csv("ACSData2020.csv") %>% 
    mutate(GEOID=as.character(GEOID))
ACSData2020
```

Let us find the median values per region.
```{r}
ACSData2020 %>% 
  group_by(Region) %>% 
  summarize(MedRentEst= median(MedRentE, na.rm=TRUE), MedTaxEst=median(MedTaxE, na.rm=TRUE), MedRentTaxRatEst=median(RentTaxRatE, na.rm=TRUE), MedRenterHHIncomeEst =median(MedRenterHHIncomeE, na.rm=TRUE), MedHHIncomeEst=median(MedHHIncomeE, na.rm=TRUE),  MedRentBurdenPercEst=median(MedRentBurdenPercE, na.rm=TRUE),  WhiteMedHHIncomeEst=median(WhiteMedHHIncomeE, na.rm=TRUE), BlackMedHHIncomeEst=median(BlackMedHHIncomeE, na.rm=TRUE), HispanicLatinoMedHHIncomeEst=median(HispanicLatinoMedHHIncomeE, na.rm=TRUE))

#med rent, med rent tax, med rent burden, gini index, total above pov, total below pov
```
visulizing some of these findings...

## Region Rent Comparison{.tabset}
 
### Region Rent Exploitation
```{r}
ggplot(ACSData2020) +
  aes(x = Region, y = RentTaxRatE) +
  geom_boxplot()
```

### Region Rent Burden
```{r}
ggplot(ACSData2020) +
  aes(x = Region, y = MedRentBurdenPercE) +
  geom_boxplot()

```
##{}

```{r}
ggplot(ACSData2020, aes(RentTaxRatE))+
  geom_histogram()+
  facet_wrap(~Region)
```
```{r}
ggplot(ACSData2020, aes(MedRentBurdenPercE))+
  geom_histogram()+
  facet_wrap(~Region)
```
```{r}
ggplot(ACSData2020)+
  aes(x=MedRentBurdenPercE, y=RentTaxRatE ) +
  geom_point()+
  geom_smooth()+
  facet_wrap(~Region)
```
Comparing rent exploitation and rent burden to see if there is a common problem such as those that are greater exploited also being greater burdened. 

```{r}
ggplot(ACSData2020) +
  aes(x = MedRentBurdenPercE) +
  geom_bar()
```

... and further by county.
```{r}
ACSData2020 %>% 
  group_by(County) %>% 
  summarize(MedRentEst= median(MedRentE, na.rm=TRUE), MedTaxEst=median(MedTaxE, na.rm=TRUE), MedRentTaxRatEst=median(RentTaxRatE, na.rm=TRUE), MedRenterHHIncomeEst =median(MedRenterHHIncomeE, na.rm=TRUE), MedHHIncomeEst=median(MedHHIncomeE, na.rm=TRUE),  MedRentBurdenPercEst=median(MedRentBurdenPercE, na.rm=TRUE),  WhiteMedHHIncomeEst=median(WhiteMedHHIncomeE, na.rm=TRUE), BlackMedHHIncomeEst=median(BlackMedHHIncomeE, na.rm=TRUE), HispanicLatinoMedHHIncomeEst=median(HispanicLatinoMedHHIncomeE, na.rm=TRUE))
```
visualizing some of these findings...

## County Rent Comparison{.tabset}
 
### County Rent Exploitation
```{r}
ggplot(ACSData2020) +
  aes(x = County, y = RentTaxRatE) +
  geom_boxplot()
```

### County Rent Burden
```{r}
ggplot(ACSData2020) +
  aes(x = County, y = MedRentBurdenPercE) +
  geom_boxplot()

```
##{}
```{r}
ggplot(ACSData2020, aes(RentTaxRatE))+
  geom_histogram()+
  facet_wrap(~County)
```

```{r}
ggplot(ACSData2020, aes(MedRentBurdenPercE))+
  geom_histogram()+
  facet_wrap(~County)
```

```{r}
ggplot(ACSData2020)+
  aes(x=MedRentBurdenPercE, y=RentTaxRatE ) +
  geom_point()+
  geom_smooth()+
  facet_wrap(~County)
```

```{r}
counties<-c("Albemarle", "Charlottesville", "Fluvanna", "Greene", "Louisa","Nelson", "Chesterfield County", "Henrico County", "Hopewell City", "Petersburg City", "Richmond City")
countytracts <- tracts(state = "51", county = counties, year = 2020)
```

As defined by Crowell, rent exploitation is the ratio of median rents to median property taxes (Crowell 2). We will examine how rent exploitation varies by counties in the Charlottesville and Richmond regions.
```{r}
ACSData2020<-countytracts %>% 
  left_join(ACSData2020, by="GEOID")
```

```{r}
ACSData2020 <- st_transform(ACSData2020, 4326)
pal <- colorNumeric("viridis", reverse = FALSE, domain = ACSData2020$RentTaxRatE) # viridis

leaflet(ACSData2020) %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons(fillColor = ~pal(RentTaxRatE),
              fillOpacity = 0.8,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 3,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("Region: ", ACSData2020$Region, "<br>",
                             "County: ", ACSData2020$County, "<br>",
                             "Tract: ", ACSData2020$NAMELSAD, "<br>",
                             "Ratio: ", round(ACSData2020$RentTaxRatE, 2)))%>% 
  addLegend("topright", pal = pal, values = ACSData2020$RentTaxRatE, 
          title = "Rent Exploitation", opacity = 0.7)
```
Recalling that if rent exploitation> 1 then the tenant is paying more than the property is worth judging by how much the owner is paying for its property tax.
```{r}
#create a filtered map that explicity shows those financially exploited?

ACSData2020 %>% 
  ggplot()+
  geom_sf(aes(fill= RentTaxRatE))+
  #geom_sf_label(aes(label = County), size=3, color ="black", fontface = "bold")+
  theme_void()
```
```{r}
ACSData2020 %>% 
  #filter(Region == "Charlottesville") %>% 
  ggplot()+
  geom_sf(aes(fill=RentTaxRatE))+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  ggtitle("Rent Exploitation in Charlottesville and Richmond, VA", subtitle= "Data from the 2020 American Community Survey (ACS)")+
  labs(fill="Rent Exploitation")

ggsave("Rent Exploitation Charlottesville and Richmond.png")
  
              
```
```{r}
ACSData2020 %>% 
  filter(Region == "Richmond") %>% 
  ggplot()+
  geom_sf(aes(fill=RentTaxRatE))+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  ggtitle("Rent Explotation in Richmond, VA", subtitle= "Data from the 2020 American Community Survey")+
  labs(fill="Rent Exploitation")
  
              
```
Additionally, rent burden is the ratio of median renters income to median rent as a measurement of rent affordabilty as if the renter is paying greater than 30% of their income they range from burdened to extremely burdened in terms of being able to spend their income on other necessities such as general welfar, transportations, groceries, etc.  We will examine how rent burden varies by counties in the Charlottesville and Richmond regions.

```{r}
ACSData2020 <- st_transform(ACSData2020, 4326)
pal <- colorNumeric("viridis", reverse = TRUE, domain = ACSData2020$MedRentBurdenPercE) # viridis

leaflet(ACSData2020) %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons(fillColor = ~pal(MedRentBurdenPercE),
              fillOpacity = 0.8,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 3,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("Region: ", ACSData2020$Region, "<br>",
                             "County: ", ACSData2020$County, "<br>",
                             "Tract: ", ACSData2020$NAMELSAD, "<br>",
                             "Percent: ", round(ACSData2020$MedRentBurdenPercE, 2)))%>% 
  addLegend("topright", pal = pal, values = ACSData2020$MedRentBurdenPercE, 
          title = "Percentage of Rent Burden", opacity = 0.7)
```

```{r}
ACSData2020 %>% 
  #filter(Region == "Charlottesville") %>% 
  ggplot()+
  geom_sf(aes(fill=MedRentBurdenPercE))+
  scale_fill_viridis_c()+
  scale_color_viridis_c()+
  ggtitle("Rent Burden in Charlottesville and Richmond, VA", subtitle= "Data from the 2020 American Community Survey (ACS)")+
  labs(fill="Rent Burden (%)")

ggsave("Rent Burden in Charlottesville and Richmond.png")
```


The darker the tract the more financially burdened by their rent. 

How does the median renters household income relate to the median rent they are paying as proof of rent burden?
```{r}
ggplot(ACSData2020) +
  aes(x = MedRenterHHIncomeE, y = MedRentE) +
  geom_point() 
```
As expected the lower the household income the less the renter can afford to pay. However does how much they are paying 

```{r}
PovertybyRace <- read_csv("PovertyByRaceData.csv") %>% 
      mutate(GEOID=as.character(GEOID))
PovertybyRace
```
```{r}

```


```{r}
TenureByRace <- read_csv("TenureByRaceData.csv") %>% 
  mutate(GEOID=as.character(GEOID))
TenureByRace
```

A representation of the percentage of Black renters in and around Charlottesville and Richmond Virginia to compare the regions with the predominately greater than Black population with the predominately rent burdened or exploited, etc.

```{r}
TenureByRace<-countytracts %>% 
  left_join(TenureByRace, by="GEOID")
```


## Percentage of Black Renters{.tabset}

### Total
```{r}

TenureByRace <- st_transform(TenureByRace, 4326)
pal <- colorNumeric("viridis", reverse = FALSE, domain = TenureByRace$PercOfBlkRenters) # viridis

leaflet(TenureByRace) %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons(fillColor = ~pal(PercOfBlkRenters),
              fillOpacity = 0.8,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 3,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("Region: ", TenureByRace$Region, "<br>",
                             "County: ", TenureByRace$County, "<br>",
                             "Tract: ", TenureByRace$NAMELSAD, "<br>",
                             "Percentage: ", round(TenureByRace$PercOfBlkRenters, 2)))%>% 
  addLegend("topright", pal = pal, values = TenureByRace$PercOfBlkRenters, 
          title = "Percentage of Black Renters", opacity = 0.7)
```

### Predominately Black Tracts
```{r}
TenureByRace <- st_transform(TenureByRace, 4326)
pal <- colorNumeric("viridis", reverse = FALSE, domain = TenureByRace$PercOfBlkRenters) # viridis

TenureByRace %>% 
  filter(PercOfBlkRenters >= 40 ) %>% 
  #create new dataframe with the above call that datafram in leaflet arguments below
leaflet() %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons(fillColor = ~pal(PercOfBlkRenters),
              fillOpacity = 0.8,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 3,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("Region: ", TenureByRace$Region, "<br>",
                             "County: ", TenureByRace$County, "<br>",
                             "Tract: ", TenureByRace$NAMELSAD, "<br>",
                             "Percentage: ", round(TenureByRace$PercOfBlkRenters, 2)))%>% 
  addLegend("topright", pal = pal, values = TenureByRace$PercOfBlkRenters, 
          title = "Percentage of Black Renters", opacity = 0.7)
```

Note the lack of representation of housholds in particular census tracts

```{r}
#joining the spatial data with the PovertybyRace dataset
PovertybyRace<-countytracts %>% 
  left_join(PovertybyRace, by="GEOID")
```

The following is a visual of the Gini Index of Charlottesville and Richmond which entails the index of income inequality in the tracts with the closer a tract is to 1 the closer they are to perfect Inequality and vice versa for 0.
```{r}
PovertybyRace <- st_transform(PovertybyRace, 4326)
pal <- colorNumeric("viridis", reverse = TRUE, domain = PovertybyRace$IncomeInequalityE) # viridis
leaflet(PovertybyRace) %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons(fillColor = ~pal(IncomeInequalityE),
              fillOpacity = 0.8,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 3,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("County: ", PovertybyRace$County, "<br>",
                             "Tract: ", PovertybyRace$NAMELSAD, "<br>",
                             "Gini Index: ", round(PovertybyRace$IncomeInequalityE, 2)))%>% 
  addLegend("topright", pal = pal, values = PovertybyRace$IncomeInequalityE, 
          title = "Gini Index of Income Inequality", opacity = 0.7)
```

scatterplot matrix
```{r}

povertymatrix<- ggpairs(PovertybyRace, mapping=aes(color=Region), columns=c(31, 39, 55, 79), title="Poverty Percentage by Race")
povertymatrix

```



```{r}
cvl_rva_measures <- read_csv("cvl_rva_measures.csv")
cvl_rva_measures<-select(cvl_rva_measures,c(1, 4,2,3))
cvl_rva_measures
```
```{r}
countytracts_updated<-countytracts %>% 
  mutate(county_tract=paste(COUNTYFP,TRACTCE, sep="")) 
```

```{r}
cvl_rva_measures<-countytracts_updated %>% 
  left_join(cvl_rva_measures,countytracts_updated, by="county_tract")
```
```{r}
cvl_rva_measures<- cvl_rva_measures %>%
  mutate(FipCodes=str_sub(GEOID,3,5)) %>% 
  mutate(County = case_when(
    FipCodes=="540"~"Charlottesville",
    FipCodes=="109"~"Louisa",
    FipCodes=="125"~"Nelson",
    FipCodes=="065"~"Fluvanna",
    FipCodes=="003"~"Albemarle",
    FipCodes=="079"~"Greene",
    FipCodes=="760"~"Richmond City",
    FipCodes=="087"~"Henrico County",
    FipCodes=="041"~"Chesterfield County", 
    FipCodes=="670"~"Hopewell City", 
    FipCodes=="730"~"Petersburg City"
    
  ))

cvl_rva_measures<-cvl_rva_measures %>% 
  mutate(Region=case_when(
    FipCodes %in% c("540","109","125", "065", "003", "079")~"Charlottesville",
    FipCodes %in% c("760","087","041", "670", "730")~"Richmond"
  ))
```


## Residential Segregation{.tabset}
 
### Dissimilarity
```{r}
cvl_rva_measures <- st_transform(cvl_rva_measures, 4326)
pal <- colorNumeric("viridis", reverse = FALSE, domain = cvl_rva_measures$dissim_wb_block) # viridis


# cvl_rva_measures %>% 
#   filter(dissim_wb_block >= 0.5 ) %>% 
leaflet(cvl_rva_measures) %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons(fillColor = ~pal(dissim_wb_block),
              fillOpacity = 0.8,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 3,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("Region: ", cvl_rva_measures$Region, "<br>",
                             "County: ", cvl_rva_measures$County, "<br>",
                             "Tract: ", cvl_rva_measures$NAMELSAD, "<br>",
                             "Dissimilarity Index ", round(cvl_rva_measures$dissim_wb_block, 2)))%>% 
  addLegend("topright", pal = pal, values = cvl_rva_measures$dissim_wb_block
, 
          title = "Dissimilarity Index", opacity = 0.7)
```

Isolation
```{r}
#cvl_rva_measures <- st_transform(cvl_rva_measures, 4326)
pal <- colorNumeric("viridis", reverse = FALSE, domain = cvl_rva_measures$iso_b_block
) # viridis
 
 
# cvl_rva_measures %>% 
#   filter(dissim_wb_block >= 0.5 ) %>% 
leaflet(cvl_rva_measures) %>% 
 #addTiles() %>% # basemap
 addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
 addPolygons(fillColor = ~pal(iso_b_block),
             fillOpacity = 0.8,
             color = "white",
             weight = 2,
             highlight = highlightOptions(
               weight = 3,
               fillOpacity = 0.9,
               bringToFront = T),
             popup = paste0("Region: ", cvl_rva_measures$Region, "<br>",
                            "County: ", cvl_rva_measures$County, "<br>",
                            "Tract: ", cvl_rva_measures$NAMELSAD, "<br>",
                            "Issolation Index ", round(cvl_rva_measures$iso_b_block, 2)))%>% 
 addLegend("topright", pal = pal, values = cvl_rva_measures$iso_b_block
, 
         title = "Issolation Index", opacity = 0.7)

```
#{}
```{r}

segregationmatrix<- ggpairs(cvl_rva_measures, mapping=aes(color=Region), columns=c(15,16), title="Resedential Segregation")
segregationmatrix

```
```{r}
DataforMatrix<-cbind(ACSData2020,TenureByRace, PovertybyRace, cvl_rva_measures) 
```

```{r}
CvlDataforMatrix<-DataforMatrix %>% 
  filter(region=="cvl")
RvaDataforMatrix<- DataforMatrix %>% 
  filter(region=="rva")

```



```{r}
 rentmatrix<- ggpairs(CvlDataforMatrix, columns=c(21,25,72, 131), mapping=aes(color=region), title="Corelation between Rent Exploitation, Burden, and Resedential Segregation in Black Renters", lower = list(continuous = "smooth"))

rentmatrix

#upper = list(continuous = "density", combo = "box_no_facet"),
#),, combo = "facetdensity"
#filter(Region ==Charlottesville)

# 
# # lower = list(continuous = "smooth"),
# r <- rentmatrix[3,1]
# # 
# # 
# r +geom_smooth()
# rentma

```
```{r}
rentmatrix<- ggpairs(DataforMatrix, columns=c(21,25,72, 67, 115), mapping=aes(color=region, alpha=0.1), title="Correlation between Rent Exploitation, Rent Burden & Select Demographic Groups", lower = list(continuous = "smooth", alpha = 1/40))
                     #

# r <- rentmatrix[5,1]
# r+scale_color_manual(values=c("#d7191c", "#2c7bb6")
rentmatrix

ggsave("Charlottesville and Richmond Scatter Plot Matrix.png")
```


#ggsave() saves as pdf