# Explore rent to tax ratio measure
# and some mapping

library(tidyverse)
library(tigris)
library(sf)
library(viridis)
library(RColorBrewer)
library(leaflet)

cvl_rent2 <- readRDS("cvl_rent.RDS")
cvl <- c("003", "540", "079","109", "065", "125")

ggplot(cvl_rent2, aes(x = rent_tax_ratio)) +
  geom_histogram(binwidth = .05)
# what's the outlier? Albemarle 113.02

# more viz and summarization, including of componenets (rent, tax)

# Mapping ----
# get tract shapefiles
cvl_tracts <- tracts(state = "51", county = cvl, year = 2020)

cvl_rents <- cvl_tracts %>% 
  left_join(cvl_rent2, by = "GEOID") # by = c("GEOID1" = "GEOID2")

ggplot(cvl_rents) +
  geom_sf(aes(fill = county)) +
  theme_void()

ggplot(cvl_rents) +
  # geom_sf(aes(color = county)) +
  geom_sf(aes(fill = rent_tax_ratio, color = NA)) +
  #scale_fill_viridis_c(option = "plasma") + # viridis
  scale_fill_distiller(palette = "YlGnBu", direction = -1) + # colorbrewer
  theme_void()


# CRS ----
# https://keen-swartz-3146c4.netlify.app/cs.html
# https://keen-swartz-3146c4.netlify.app/sf.html#projsf
st_crs(cvl_rents)

# Robinson
ggplot(cvl_rents) +
  geom_sf(aes(fill = rent_tax_ratio)) +
  scale_fill_viridis_c(option = "plasma") + 
  coord_sf(crs = "+proj=robin") +
  theme_void()

# Sinusoidal
ggplot(cvl_rents) +
  geom_sf(aes(fill = rent_tax_ratio)) +
  scale_fill_viridis_c(option = "plasma") + 
  coord_sf(crs = st_crs("ESRI:54008")) +
  theme_void()


# Leaflet ----
# https://rstudio.github.io/leaflet/
# Leaflet expects the CRS to be 4326
cvl_rents <- st_transform(cvl_rents, 4326)

# basic leaflet map
leaflet(cvl_rents) %>% 
  #addTiles() %>% # basemap
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons()

# change the color/weight of polygon outline
leaflet(cvl_rents) %>% 
  #addTiles() %>% 
  addProviderTiles("CartoDB.Positron") %>% # CartoDB.Positron, Stamen.Toner, Esri.NatGeoWorldMap
  addPolygons(color = "black",
              weight = 2,
              fillOpacity = 0.1)

# add color palette for choropleth
pal <- colorNumeric("viridis", reverse = TRUE, domain = cvl_rents$rent_tax_ratio) # viridis

leaflet(cvl_rents) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(fillColor = ~pal(rent_tax_ratio),
              fillOpacity = 0.8,
              color = "white",
              weight = 2)

# add legend
leaflet(cvl_rents) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(fillColor = ~pal(rent_tax_ratio),
              fillOpacity = 0.8,
              color = "white",
              weight = 2) %>% 
  addLegend("topright", pal = pal, values = cvl_rents$rent_tax_ratio, 
            title = "Rent/Tax Ratio", opacity = 0.7)

# add hovering functionality
leaflet(cvl_rents) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(fillColor = ~pal(rent_tax_ratio),
              fillOpacity = 0.6,
              color = "white",
              weight = 1,
              highlight = highlightOptions(
                weight = 3,
                fillOpacity = 0.9,
                bringToFront = T)) %>% 
  addLegend("topright", pal = pal, values = cvl_rents$rent_tax_ratio, 
            title = "Rent/Tax Ratio", opacity = 0.7)

# add popup info
leaflet(cvl_rents) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(fillColor = ~pal(rent_tax_ratio),
              fillOpacity = 0.6,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("County: ", cvl_rents$county, "<br>",
                             "Tract: ", cvl_rents$NAMELSAD, "<br>",
                             "Rent/Tax Ratio: ", round(cvl_rents$rent_tax_ratio, 2))) %>% 
  addLegend("topright", pal = pal, values = cvl_rents$rent_tax_ratio, 
            title = "Rent/Tax Ratio", opacity = 0.7)

# Get rid of the NA?
# Only by getting rid of polygon altogether
cvl_rents_nomiss <- cvl_rents %>% 
  filter(!is.na(rent_tax_ratio))

leaflet(cvl_rents_nomiss) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(fillColor = ~pal(rent_tax_ratio),
              fillOpacity = 0.6,
              color = "white",
              weight = 2,
              highlight = highlightOptions(
                weight = 2,
                fillOpacity = 0.9,
                bringToFront = T),
              popup = paste0("County: ", cvl_rents_nomiss$county, "<br>",
                             "Tract: ", cvl_rents_nomiss$NAMELSAD, "<br>",
                             "Rent/Tax Ratio: ", round(cvl_rents_nomiss$rent_tax_ratio, 2))) %>% 
  addLegend("topright", pal = pal, values = cvl_rents_nomiss$rent_tax_ratio, 
            title = "Rent/Tax Ratio", opacity = 0.7)
